{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h4><i class="fas fa-file-invoice me-2"></i>Historial de Facturas</h4>
  <a href="/" class="btn btn-outline-primary">
    <i class="fas fa-arrow-left me-1"></i>Volver al Inicio
  </a>
</div>

<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover" id="invoicesTable">
        <thead class="table-dark">
          <tr>
            <th>Número</th>
            <th>Fecha</th>
            <th>Cliente</th>
            <th>Subtotal</th>
            <th>IVA</th>
            <th>Total</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="7" class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
async function loadInvoicesHistory() {
  try {
    const response = await fetch('/api/invoices/history');
    const invoices = await response.json();
    
    const tbody = document.querySelector('#invoicesTable tbody');
    tbody.innerHTML = '';
    
    if (invoices.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="text-center text-muted">
            <i class="fas fa-inbox me-2"></i>No hay facturas registradas
          </td>
        </tr>
      `;
      return;
    }
    
    invoices.forEach(invoice => {
      const row = document.createElement('tr');
      const date = new Date(invoice.date);
      row.innerHTML = `
        <td><strong>${invoice.number}</strong></td>
        <td>${date.toLocaleDateString('es-CO')}</td>
        <td>${invoice.customer.name}</td>
        <td>${money(invoice.subtotal_excl_vat)}</td>
        <td>${money(invoice.vat_total)}</td>
        <td><strong>${money(invoice.total)}</strong></td>
        <td>
          <a href="/invoice/${invoice.id}" target="_blank" class="btn btn-sm btn-outline-primary">
            <i class="fas fa-eye me-1"></i>Ver
          </a>
        </td>
      `;
      tbody.appendChild(row);
    });
  } catch (error) {
    console.error('Error cargando historial de facturas:', error);
    const tbody = document.querySelector('#invoicesTable tbody');
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="text-center text-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>Error cargando datos
        </td>
      </tr>
    `;
  }
}

// Cargar datos al cargar la página
document.addEventListener('DOMContentLoaded', loadInvoicesHistory);
</script>
{% endblock %}
